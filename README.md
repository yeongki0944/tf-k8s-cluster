# Terraform Kubernetes Cluster on AWS

AWS EC2 ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•´ Kubernetes í´ëŸ¬ìŠ¤í„°ë¥¼ ìë™ìœ¼ë¡œ ë°°í¬í•˜ëŠ” Terraform ì½”ë“œì…ë‹ˆë‹¤.

## ğŸ¯ ëª©ì 

- **í•™ìŠµìš©**: Kubernetes í´ëŸ¬ìŠ¤í„° êµ¬ì„± ìš”ì†Œì™€ ë„¤íŠ¸ì›Œí‚¹ ì´í•´
- **ì‹¤ìŠµí™˜ê²½**: kubeadmì„ ì‚¬ìš©í•œ í´ëŸ¬ìŠ¤í„° êµ¬ì¶• ê³¼ì • í•™ìŠµ
- **ìë™í™”**: Terraformì„ í†µí•œ ì¸í”„ë¼ ì½”ë“œ ê´€ë¦¬ ê²½í—˜

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         VPC (10.250.0.0/16)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Public Subnet 1        â”‚  Public Subnet 2                  â”‚
â”‚  (10.250.1.0/24)        â”‚  (10.250.2.0/24)                  â”‚
â”‚                         â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Master Node    â”‚    â”‚  â”‚  Worker Node 1  â”‚              â”‚
â”‚  â”‚  (t3.medium)    â”‚    â”‚  â”‚  (t3.small)     â”‚              â”‚
â”‚  â”‚  Control Plane  â”‚    â”‚  â”‚                 â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                         â”‚                                   â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                         â”‚  â”‚  Worker Node 2  â”‚              â”‚
â”‚                         â”‚  â”‚  (t3.small)     â”‚              â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                         â”‚                                   â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                         â”‚  â”‚  Worker Node 3  â”‚              â”‚
â”‚                         â”‚  â”‚  (t3.small)     â”‚              â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ ì‚¬ì „ ìš”êµ¬ì‚¬í•­

### 1. í•„ìš”í•œ ë„êµ¬
- [Terraform](https://www.terraform.io/downloads) (>= 1.0)
- [AWS CLI](https://aws.amazon.com/cli/) (>= 2.0)

### 2. AWS ìê²©ì¦ëª… ì„¤ì •

#### ë°©ë²• 1: IAM Role Anywhere (ê¶Œì¥ - í˜„ì¬ ì‚¬ìš© ì¤‘)
ë³¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” IAM Role Anywhereì™€ ì‚¬ì„¤ ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ AWS ìê²©ì¦ëª…ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

#### ë°©ë²• 2: Access Key ë°©ì‹
```bash
# AWS CLI ì„¤ì •
aws configure --profile mzadmin
# AWS Access Key ID ì…ë ¥
# AWS Secret Access Key ì…ë ¥
# Default region: ap-northeast-2
```

#### ë°©ë²• 3: IAM Role ë°©ì‹
EC2ì—ì„œ ì‹¤í–‰ ì‹œ IAM Roleì„ ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

## ğŸš€ ì‚¬ìš© ë°©ë²•

### 1. ì½”ë“œ í´ë¡  ë° ì„¤ì •
```bash
git clone https://github.com/yeongki0944/tf-k8s-cluster.git
cd tf-k8s-cluster

# terraform.tfvars íŒŒì¼ í™•ì¸ ë° ìˆ˜ì •
cp terraform.tfvars.example terraform.tfvars
```

### 2. ë°°í¬ ì‹¤í–‰
```bash
# Terraform ì´ˆê¸°í™”
terraform init

# ë°°í¬ ê³„íš í™•ì¸
terraform plan

# í´ëŸ¬ìŠ¤í„° ë°°í¬ (10-15ë¶„ ì†Œìš”)
terraform apply
```

### 3. í´ëŸ¬ìŠ¤í„° ì ‘ì†
```bash
# SSH í‚¤ íŒŒì¼ ê¶Œí•œ ì„¤ì •
chmod 600 test-cluster-key.pem

# ë§ˆìŠ¤í„° ë…¸ë“œ ì ‘ì†
ssh -i test-cluster-key.pem ec2-user@<MASTER_PUBLIC_IP>

# í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸
kubectl get nodes
kubectl get pods -n kube-system
```

## ğŸ”§ êµ¬ì„± ìš”ì†Œ

### ì¸í”„ë¼ ë¦¬ì†ŒìŠ¤
- **VPC**: 10.250.0.0/16 CIDR ë¸”ë¡
- **ì„œë¸Œë„·**: 2ê°œ í¼ë¸”ë¦­ ì„œë¸Œë„· (Multi-AZ)
- **ë³´ì•ˆê·¸ë£¹**: ë§ˆìŠ¤í„°/ì›Œì»¤ ë…¸ë“œìš© (í•™ìŠµìš©ìœ¼ë¡œ ëª¨ë“  í¬íŠ¸ ê°œë°©)
- **EC2 ì¸ìŠ¤í„´ìŠ¤**: ë§ˆìŠ¤í„° 1ê°œ + ì›Œì»¤ 3ê°œ
- **IAM**: ë…¸ë“œìš© Role ë° Parameter Store ì ‘ê·¼ ê¶Œí•œ

### Kubernetes êµ¬ì„±
- **Container Runtime**: containerd
- **CNI**: Calico
- **Join Token**: AWS Parameter Storeì— ìë™ ì €ì¥
- **kubeconfig**: ë§ˆìŠ¤í„° ë…¸ë“œ `/home/ec2-user/.kube/config`

## ğŸ“Š ë¹„ìš© ì˜ˆìƒ (ap-northeast-2 ê¸°ì¤€)

| ë¦¬ì†ŒìŠ¤ | íƒ€ì… | ì‹œê°„ë‹¹ | ì›” ì˜ˆìƒ |
|--------|------|--------|---------|
| Master Node | t3.medium | ~$0.0416 | ~$30 |
| Worker Nodes | 3 x t3.small | ~$0.0624 | ~$45 |
| **ì´í•©** | | **~$0.104** | **~$75** |

*EBS ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ë³„ë„

## ğŸ“ ì„¤ì • ë³€ê²½

`terraform.tfvars` íŒŒì¼ì—ì„œ ë‹¤ìŒ ê°’ë“¤ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```hcl
# í´ëŸ¬ìŠ¤í„° ì„¤ì •
cluster_name = "my-cluster"      # í´ëŸ¬ìŠ¤í„° ì´ë¦„
worker_count = 2                 # ì›Œì»¤ ë…¸ë“œ ê°œìˆ˜

# ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…
master_instance_type = "t3.large"
worker_instance_type = "t3.medium"

# ë„¤íŠ¸ì›Œí¬ ì„¤ì •
vpc_cidr = "172.16.0.0/16"
public_subnet_cidrs = [
  "172.16.1.0/24",
  "172.16.2.0/24"
]
```

## ğŸ” ë¡œê·¸ ëª¨ë‹ˆí„°ë§

### ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸
```bash
# ë¡œì»¬ì—ì„œ ìˆ˜ì§‘ëœ ë¡œê·¸ í™•ì¸
tail -f ./logs/master-<CLUSTER_ID>.log
tail -f ./logs/worker-1-<CLUSTER_ID>.log

# ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì§ì ‘ í™•ì¸
ssh -i test-cluster-key.pem ec2-user@<IP>
tail -f /var/log/k8s-master-<CLUSTER_ID>.log
```

### í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸
```bash
# ë…¸ë“œ ìƒíƒœ
kubectl get nodes -o wide

# ì‹œìŠ¤í…œ íŒŒë“œ ìƒíƒœ
kubectl get pods -n kube-system

# í´ëŸ¬ìŠ¤í„° ì •ë³´
kubectl cluster-info
```

## âš ï¸ ë³´ì•ˆ ì£¼ì˜ì‚¬í•­

**í˜„ì¬ ì„¤ì •ì€ í•™ìŠµìš©ì…ë‹ˆë‹¤:**
- ë³´ì•ˆê·¸ë£¹ì´ ëª¨ë“  íŠ¸ë˜í”½(0.0.0.0/0)ì„ í—ˆìš©
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” í•„ìš”í•œ í¬íŠ¸ë§Œ ê°œë°©í•˜ì„¸ìš”

### í”„ë¡œë•ì…˜ìš© ë³´ì•ˆ ê°•í™”
```hcl
# ë§ˆìŠ¤í„° ë…¸ë“œ ë³´ì•ˆê·¸ë£¹ ì˜ˆì‹œ
ingress {
  from_port   = 6443
  to_port     = 6443
  protocol    = "tcp"
  cidr_blocks = ["<YOUR_IP>/32"]  # API Server
}

ingress {
  from_port   = 22
  to_port     = 22
  protocol    = "tcp"
  cidr_blocks = ["<YOUR_IP>/32"]  # SSH
}
```

## ğŸ”§ ë¬¸ì œí•´ê²°

### ë§ˆìŠ¤í„° ë…¸ë“œ ì´ˆê¸°í™” ì‹¤íŒ¨
```bash
# ë¡œê·¸ í™•ì¸
ssh -i test-cluster-key.pem ec2-user@<MASTER_IP>
sudo tail -f /var/log/k8s-master-*.log

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
sudo systemctl status kubelet
sudo systemctl status containerd
```

### ì›Œì»¤ ë…¸ë“œ ì¡°ì¸ ì‹¤íŒ¨
```bash
# ì¡°ì¸ í† í° í™•ì¸
aws ssm get-parameter --name "/k8s/<CLUSTER_ID>/join-command" --with-decryption

# ì›Œì»¤ ë…¸ë“œì—ì„œ ì¬ì‹œë„
sudo kubeadm reset
# ìœ„ì—ì„œ í™•ì¸í•œ ì¡°ì¸ ëª…ë ¹ì–´ ì‹¤í–‰
```

### ì¼ë°˜ì ì¸ ì´ìŠˆ
- **ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ**: ë³´ì•ˆê·¸ë£¹ ê·œì¹™ í™•ì¸
- **ê¶Œí•œ ë¬¸ì œ**: IAM Role ë° ì •ì±… í™•ì¸
- **íƒ€ì„ì•„ì›ƒ**: ì¸ìŠ¤í„´ìŠ¤ í¬ê¸°ê°€ ì¶©ë¶„í•œì§€ í™•ì¸

## ğŸ§¹ ë¦¬ì†ŒìŠ¤ ì •ë¦¬

```bash
# ì „ì²´ ì¸í”„ë¼ ì‚­ì œ
terraform destroy

# ë¡œì»¬ íŒŒì¼ ì •ë¦¬ (ìë™ ì‹¤í–‰ë¨)
# - SSH í‚¤ íŒŒì¼ (*.pem)
# - ë¡œê·¸ í´ë” (./logs/)
# - ì„ì‹œ íŒŒì¼ë“¤
```

## ğŸ“„ ë¼ì´ì„ ìŠ¤

ì´ í”„ë¡œì íŠ¸ëŠ” í•™ìŠµ ëª©ì ìœ¼ë¡œ ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤.
